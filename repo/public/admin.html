<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catalogue Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{background:linear-gradient(180deg,#f5f7fb 0%,#eef1f6 100%);}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .glass{background:#fff;border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .mac-titlebar{height:40px}
    .traffic-dot{width:12px;height:12px;border-radius:9999px}
    .ring-focus:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.35)}
    .seg{display:inline-flex;padding:4px;background:#f1f5f9;border-radius:9999px;box-shadow:inset 0 1px 0 rgba(0,0,0,.02)}
    .seg button{padding:.45rem .9rem;border-radius:9999px;font-weight:600;transition:all .2s ease;white-space:nowrap}
    .seg .on{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04),0 2px 8px rgba(0,0,0,.08)}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .fade-in-up{animation:fadeInUp .5s ease-out both}
    .card-hover{transition:transform .18s ease,box-shadow .25s ease,border-color .25s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 18px 60px rgba(2,6,23,.08);border-color:rgba(2,6,23,.08)}
    .btn-soft{transition:transform .15s ease,filter .2s ease,background-color .2s ease,box-shadow .2s ease}
    .btn-soft:active{transform:scale(.98)}
    .input-soft{transition:box-shadow .2s ease,border-color .2s ease,background-color .2s ease}
    .input-soft:hover{box-shadow:inset 0 0 0 2px rgba(15,23,42,.08)}
    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:60}
    .toast{display:flex;align-items:center;gap:10px;border-radius:14px;padding:10px 14px;color:#0f172a;background:#fff;border:1px solid rgba(2,6,23,.08);box-shadow:0 18px 50px rgba(2,6,23,.12)}
    .toast-success{border-color:rgba(16,185,129,.35)}
    .toast-error{border-color:rgba(239,68,68,.35)}
    .toast-info{border-color:rgba(59,130,246,.35)}
    .fab-stack{position:fixed;right:16px;bottom:calc(env(safe-area-inset-bottom,0) + 16px);z-index:60}
    .fab-col{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .fab-btn-sm{border-radius:9999px;padding:.45rem .7rem;font-size:.8rem;font-weight:600;box-shadow:0 10px 26px rgba(2,6,23,.18)}
    .seg-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .seg-scroll::-webkit-scrollbar{display:none}
    @media (prefers-color-scheme: dark){
      html,body{background:linear-gradient(180deg,#0b0f16 0%,#0f1520 100%)}
      .glass{background:#1b222c;border-color:rgba(255,255,255,.08)}
      .seg{background:#111827}.seg .on{background:#1f2937;color:#f9fafb}
      .toast{background:#1f2937;color:#e5e7eb}
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-28 sm:pb-6">
    <div class="glass mac-titlebar rounded-2xl px-4 flex items-center gap-3 mb-5 fade-in-up">
      <div class="flex items-center gap-2">
        <span class="traffic-dot" style="background:#ff5f57"></span>
        <span class="traffic-dot" style="background:#febc2e"></span>
        <span class="traffic-dot" style="background:#28c840"></span>
      </div>
      <div class="text-sm text-slate-600 ml-2">Catalogue Admin</div>
    </div>

    <div id="root"></div>
  </div>

  <script type="text/babel" data-presets="env,react">
    // -----------------------------
    // THEME-REGISTRY: add new theme configs here
    // -----------------------------
    const BUILTIN_THEME_CONFIGS = {
      default:{label:'Default / Classic',fields:[
        {name:'main',kind:'file',label:'Main Tile Image',accept:'image/*',multiple:false,required:true},
        {name:'variants',kind:'file',label:'Variation Images',accept:'image/*',multiple:true},
        {name:'video',kind:'file',label:'Video (MP4)',accept:'video/mp4',multiple:false},
        {name:'preview',kind:'file',label:'Preview (optional, single)',accept:'image/*',multiple:false},
        {name:'size_text',kind:'text',label:'Size (Text)',placeholder:'e.g., 800x1600'}
      ]},
      neo:{label:'Neo / Dual Main + Badge + Previews',fields:[
        {name:'main_left',kind:'file',label:'Main Tile (Left)',accept:'image/*',multiple:false,required:true},
        {name:'main_right',kind:'file',label:'Main Tile (Right)',accept:'image/*',multiple:false,required:true},
        {name:'swatches',kind:'file',label:'Small Swatches (grid)',accept:'image/*',multiple:true},
        {name:'previews',kind:'file',label:'Preview Images (optional, multiple)',accept:'image/*',multiple:true},
        {name:'size_badge',kind:'file',label:'Size Badge (PNG/SVG, optional)',accept:'image/*',multiple:false},
        {name:'size_text',kind:'text',label:'Size (Text)',placeholder:'e.g., 600x1200'}
      ]},
      '12x18theme': {
        label: '12x18',
        fields: [
          // A boxes accept 1 or 2 files; we'll auto-create B on submit
          { name: 'tile1a', kind: 'file', label: 'Tile 1 (LT) — upload 1 or 2', accept: 'image/*', multiple: true, required: true },
          { name: 'tile2a', kind: 'file', label: 'Tile 2 (HL) — upload 1 or 2', accept: 'image/*', multiple: true, required: true },
          { name: 'tile3a', kind: 'file', label: 'Tile 3 (DK) — upload 1 or 2', accept: 'image/*', multiple: true, required: true },

          { name: 'preview',  kind: 'file', label: 'Preview (large, optional)', accept: 'image/*', multiple: false },

          { name: 'tile1name', kind: 'text', label: 'Tile 1 Name', placeholder: 'e.g., LT Carrara' },
          { name: 'tile2name', kind: 'text', label: 'Tile 2 Name', placeholder: 'e.g., HL Geometry' },
          { name: 'tile3name', kind: 'text', label: 'Tile 3 Name', placeholder: 'e.g., DK Nero' },
          { name: 'finish',    kind: 'text', label: 'Finish',      placeholder: 'e.g., Glossy' },
          { name: 'random',    kind: 'text', label: 'Random',      placeholder: 'e.g., 1 Face / 10 Face' },
          { name: 'size_text', kind: 'text', label: 'Size (Text)', placeholder: 'e.g., 300 × 450mm' }
        ]
      }
    };

    const themeConfigs = Object.assign({},BUILTIN_THEME_CONFIGS,(window.EXTRA_THEME_CONFIGS||{}));

    // -----------------------------
    // History helpers (Finish / Size / Random)
    // -----------------------------
    const HISTORY_KEYS = {
      finish: 'hist:finish',
      size:   'hist:size_text',
      random: 'hist:random'
    };
    const HISTORY_DEFAULTS = {
      finish: ['Glossy','Matte','Sugar','Carving','Lapato','High Gloss','Antibacterial'],
      size:   ['300×450mm','600×1200mm','800×1600mm','1200×2400mm','1200×2780mm'],
      random: ['1 Face','2 Face','4 Face','8 Face','10 Face','Random Faces']
    };
    const readHist = (k) => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch { return []; } };
    const writeHist = (k, arr) => localStorage.setItem(k, JSON.stringify(arr.slice(0, 20)));
    const pushHistValue = (kind, v) => {
      if (!v || !String(v).trim()) return;
      const key = HISTORY_KEYS[kind];
      const val = String(v).trim();
      const cur = readHist(key);
      const next = [val, ...cur.filter(x => x.toLowerCase() !== val.toLowerCase())];
      writeHist(key, next);
    };

    const labelFromFile=(file)=>{
      if(!file) return "";
      const base=(file.name||"").replace(/\.[^.]+$/,"");
      return base.replace(/[_\-]+/g," ").replace(/\s+/g," ").trim().toUpperCase()
    };

    const Toast=({toast})=>{
      if(!toast) return null;
      const {kind='info',text=''}=toast;
      const color=kind==='success'?'toast-success':kind==='error'?'toast-error':'toast-info';
      return(<div className="toast-wrap"><div className={`toast ${color}`}><span className="text-sm font-medium">{text}</span></div></div>);
    };

    function Field({def,value,onChange,rememberValue}){
      if(def.kind==='text'){
        // Attach datalist for Finish / Size / Random
        const listId =
          def.name === 'finish'    ? 'finishList' :
          def.name === 'size_text' ? 'sizeList'   :
          def.name === 'random'    ? 'randomList' : null;

        const onBlur = (e) => {
          const v = e.target.value;
          if (def.name === 'finish')    rememberValue('finish', v);
          if (def.name === 'size_text') rememberValue('size',   v);
          if (def.name === 'random')    rememberValue('random', v);
        };

        return(<div className="glass p-3 rounded-xl fade-in-up card-hover">
          <label className="block text-[13px] font-semibold mb-1 text-slate-700">{def.label}</label>
          <input
            className="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
            placeholder={def.placeholder||''}
            value={value||''}
            onChange={(e)=>onChange(e.target.value)}
            list={listId || undefined}
            onBlur={onBlur}
          />
        </div>);
      }
      return(<div className="glass p-3 rounded-xl fade-in-up card-hover">
        <label className="block text-[13px] font-semibold mb-1 text-slate-700">{def.label}{def.required?' *':''}</label>
        <input type="file" accept={def.accept||'*'} multiple={!!def.multiple}
               className="block w-full text-[15px] text-slate-600 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-900 file:px-4 file:py-3 file:text-white hover:file:bg-black/90 ring-focus bg-white rounded-lg border border-slate-200 input-soft"
               onChange={(e)=>onChange(def.multiple?[...e.target.files]:e.target.files[0])}/>
      </div>);
    }

    function App(){
      const [designs,setDesigns]=React.useState([]);
      const [loading,setLoading]=React.useState(true);
      const [label,setLabel]=React.useState('');
      const [finish,setFinish]=React.useState('Glossy');
      const [faces,setFaces]=React.useState(4);
      const initialTheme = (() => {
      const p = new URLSearchParams(location.search);
  return (p.get('theme') || 'default');
})();
      const [theme, setTheme] = React.useState(initialTheme);
      const [dyn,setDyn]=React.useState({});
      const [submitting,setSubmitting]=React.useState(false);
      const [formKey,setFormKey]=React.useState(0);
      const [showDesigns,setShowDesigns]=React.useState(true);
const handleAddPage = () => openAdminForTheme(themeKey);


      // PERSISTENT sortMode
      const [sortMode,setSortMode]=React.useState(
        () => localStorage.getItem('sortMode') || 'time_desc'
      );
      React.useEffect(()=>{
        localStorage.setItem('sortMode', sortMode);
      },[sortMode]);

      const [manualList,setManualList]=React.useState([]);
      const dragIndex=React.useRef(null);
      const [toast,setToast]=React.useState(null);
      const showToast=(text,kind='info',ms=2200)=>{const t={id:Date.now(),text,kind};setToast(t);setTimeout(()=>setToast(c=>(c&&c.id===t.id)?null:c),ms);};

      // history state for datalists
      const [hist, setHist] = React.useState({ finish: [], size: [], random: [] });
      const refreshHist = () => setHist({
        finish: readHist(HISTORY_KEYS.finish),
        size:   readHist(HISTORY_KEYS.size),
        random: readHist(HISTORY_KEYS.random),
      });
      React.useEffect(refreshHist, []);
      const rememberValue = (kind, value) => { pushHistValue(kind, value); refreshHist(); };

      React.useEffect(()=>{fetch('/api/designs').then(r=>r.json()).then(d=>setDesigns(d.designs||[])).finally(()=>setLoading(false));},[]);
      React.useEffect(()=>{setDyn({}); setLabel('');},[theme]);

      // === Auto-detect tile names for 12x18theme (supports 1 or 2 files per A box) ===
      React.useEffect(() => {
        if (theme !== '12x18theme') return;
        const firstFile = (v) => Array.isArray(v) ? v[0] : v;
        const fnameToLabel = (v) => (v && v.name) ? labelFromFile(v) : '';
        const f1 = firstFile(dyn.tile1a);
        const f2 = firstFile(dyn.tile2a);
        const f3 = firstFile(dyn.tile3a);
        const next = {};
        if (f1 && !(dyn.tile1name ?? '').trim()) next.tile1name = fnameToLabel(f1);
        if (f2 && !(dyn.tile2name ?? '').trim()) next.tile2name = fnameToLabel(f2);
        if (f3 && !(dyn.tile3name ?? '').trim()) next.tile3name = fnameToLabel(f3);
        if (Object.keys(next).length) setDyn((p) => ({ ...p, ...next }));
      }, [theme, dyn.tile1a, dyn.tile2a, dyn.tile3a, dyn.tile1name, dyn.tile2name, dyn.tile3name]);

      // preserve manual order by ID
      React.useEffect(()=>{
        if(sortMode!=='manual') return;
        const themeKey = theme || 'default';
        const themed = (designs||[]).filter(d => (d.theme||'default') === themeKey);
        setManualList(prev => {
          const order = new Map(prev.map((d,i)=>[d.id,i]));
          return themed.slice().sort((a,b)=> (order.get(a.id) ?? 1e9) - (order.get(b.id) ?? 1e9));
        });
      },[designs,theme,sortMode]);

      // -----------------------------
      // AUTO-LABEL (ALL THEMES)
      // -----------------------------
      React.useEffect(()=>{
        if (label && label.trim()) return;
        const cfg = themeConfigs[theme];
        if (!cfg) return;
        // Find first available file field (prefer required)
        const fileFields = cfg.fields.filter(f => f.kind !== 'text');
        const ordered = [
          ...fileFields.filter(f => f.required),
          ...fileFields.filter(f => !f.required)
        ];
        for (const def of ordered) {
          const v = dyn[def.name];
          if (!v) continue;
          const first = def.multiple ? (Array.isArray(v) ? v[0] : null) : v;
          if (first && first.name) {
            const g = labelFromFile(first);
            if (g) { setLabel(g); break; }
          }
        }
      }, [theme, label, JSON.stringify(dyn)]);

      const onUpload=async(e)=>{
        e.preventDefault(); if(submitting) return; setSubmitting(true); showToast('Uploading…','info',1500);
        const fd=new FormData(); fd.append('theme',theme); if(label) fd.append('label',label); fd.append('finish',finish); fd.append('faces',String(faces));
        for(const def of themeConfigs[theme].fields){
          const v=dyn[def.name];
          if(def.kind==='text'){ if(v) fd.append(`data[${def.name}]`,v); }
          else{
            if(!v){ if(def.required){ showToast(`Please add: ${def.label}`,'error',2200); setSubmitting(false); return;} continue; }
            if(def.multiple) for(const f of v) fd.append(def.name.includes('preview')||theme!=='default'?`files[${def.name}][]`:`${def.name}[]`,f);
            else fd.append(theme==='default'?def.name:`files[${def.name}]`,v);
          }
        }
        try{
          const res=await fetch('/api/upload',{method:'POST',body:fd});
          const out=await res.json();
          if(!res.ok){ showToast(out.error||'Upload failed','error',2600); return; }

          // remember current typed histories on successful save
          rememberValue('finish', finish);
          if (dyn.size_text) rememberValue('size', dyn.size_text);
          if (dyn.random)    rememberValue('random', dyn.random);

          setDesigns(out.designs||[]); setLabel(''); setFinish('Glossy'); setFaces(4); setDyn({}); setFormKey(k=>k+1);
          showToast('Saved ✓','success');
        }catch{ showToast('Upload failed','error',2600); }
        finally{ setSubmitting(false); }
      };

      const filteredSortedDesigns=React.useMemo(()=>{
        const t=theme||'default'; const list=(designs||[]).filter(d=>(d.theme||'default')===t);
        if(sortMode==='manual') return manualList;
        const arr=list.slice();
        if(sortMode==='name_asc') arr.sort((a,b)=>(a.label||'').localeCompare(b.label||'',undefined,{sensitivity:'base'}));
        else if(sortMode==='time_desc') arr.sort((a,b)=>(b.updatedAt||b.createdAt||0)-(a.updatedAt||a.createdAt||0));
        return arr;
      },[designs,theme,sortMode,manualList]);

      const deleteDesign=async(d)=>{
        if(!confirm(`Remove “${d.label}”? This will delete its files too.`)) return;
        showToast('Deleting…','info',1000);
        const res=await fetch(`/api/designs/${encodeURIComponent(d.id)}`,{method:'DELETE'});
        const out=await res.json().catch(()=>({}));
        if(!res.ok){ showToast(out?.error||'Delete failed','error',2600); return; }
        setDesigns(out.designs||[]); showToast('Deleted ✓','success');
      };

      const saveManualOrder=async()=>{
        const ids=manualList.map(d=>d.id);
        showToast('Saving order…','info',1000);
        const res=await fetch('/api/designs/order',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({theme,order:ids})});
        const out=await res.json();
        if(!res.ok){ showToast(out.error||'Failed to save order','error',2600); return; }
        setDesigns(out.designs||[]); showToast('Order saved ✓','success');
      };

      const FullCatalogueBtn=({theme,sortMode,size})=>{
        const base=`${location.origin}/index.html?theme=${encodeURIComponent(theme)}`;
        const href=sortMode==='manual'?base:`${base}&sort=${encodeURIComponent(sortMode)}`;
        const sizeCls=size==='sm'?'px-3 py-2 text-[13px]':'px-4 py-2 text-sm';
        return(<a href={href} target="_blank" rel="noopener"
                 className={`inline-flex items-center gap-2 rounded-2xl bg-slate-900 text-white shadow-sm hover:bg-black/90 ring-focus btn-soft ${sizeCls}`}>
          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6.75A2.75 2.75 0 016.75 4h10.5A2.75 2.75 0 0120 6.75v10.5A2.75 2.75 0 0117.25 20H6.75A2.75 2.75 0 014 17.25V6.75zm3 .75h10v9H7v-9z"/></svg>
          Open Full Catalogue
        </a>);
      };

      const onDragStart=(i)=>(e)=>{dragIndex.current=i;e.dataTransfer.effectAllowed='move'};
      const onDragOver=(i)=>(e)=>{e.preventDefault();e.dataTransfer.dropEffect='move'};
      const onDrop=(i)=>(e)=>{e.preventDefault();const from=dragIndex.current;if(from===null||from===undefined||from===i)return;
        setManualList(list=>{const arr=list.slice();const [m]=arr.splice(from,1);arr.splice(i,0,m);return arr;});dragIndex.current=null;};

      const DesktopToolbar=()=>{
        return (
          <div className="hidden sm:block">
            <div className="glass rounded-2xl p-4 fade-in-up sticky top-3 z-30">
              <div className="flex items-center justify-between gap-3">
                <div className="seg">
                  <button type="button" className={(sortMode==='name_asc'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('name_asc')}>A–Z</button>
                  <button type="button" className={(sortMode==='time_desc'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('time_desc')}>New → Old</button>
                  <button type="button" className={(sortMode==='manual'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('manual')}>Manual</button>
                </div>
                <div className="flex items-center gap-3">
                  <button type="button" onClick={()=>setShowDesigns(s=>!s)}
                          className="inline-flex items-center gap-2 rounded-full bg-white border border-slate-200 text-slate-700 shadow-sm hover:bg-slate-50 ring-focus px-3 py-2">
                    {showDesigns?'Hide':'Show'} designs
                  </button>
                  <select className="rounded-full bg-white px-3 py-1.5 border border-slate-200 text-sm ring-focus input-soft"
                          value={theme} onChange={(e)=>setTheme(e.target.value)} title="Theme">
                    {Object.entries(themeConfigs).map(([k,v])=>(<option key={k} value={k}>{v.label}</option>))}
                  </select>
                  <FullCatalogueBtn theme={theme} sortMode={sortMode}/>
                </div>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="space-y-6">
          <DesktopToolbar/>
          <form id="uploadForm" onSubmit={onUpload} key={formKey} className="glass rounded-2xl p-5 space-y-4 fade-in-up">
            {/* Top controls */}
            {theme === '12x18theme' ? (
              // 12x18: only Theme selector (its Finish/Size/Random are inside Field grid)
              <div className="grid gap-3 sm:grid-cols-1">
                <select
                  className="rounded-xl border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
                  value={theme}
                  onChange={(e)=>setTheme(e.target.value)}
                >
                  {Object.entries(themeConfigs).map(([k,v])=>(
                    <option key={k} value={k}>{v.label}</option>
                  ))}
                </select>
              </div>
            ) : (
              // Other themes: show label/finish/faces/theme in the top bar
              <div className="grid gap-3 sm:grid-cols-4">
                <input
                  className="rounded-xl border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
                  placeholder="Design Label (auto if left blank)"
                  value={label}
                  onChange={(e)=>setLabel(e.target.value)}
                />
                <input
                  className="rounded-xl border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
                  placeholder="Finish (e.g., Glossy)"
                  value={finish}
                  onChange={(e)=>setFinish(e.target.value)}
                  list="finishList"
                  onBlur={(e)=>rememberValue('finish', e.target.value)}
                />
                <input
                  type="number" min="1" inputMode="numeric" pattern="[0-9]*"
                  className="rounded-xl border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
                  placeholder="Faces"
                  value={faces}
                  onChange={(e)=>setFaces(Number(e.target.value)||1)}
                />
                <select
                  className="rounded-xl border border-slate-200 bg-white px-3 py-2 ring-focus input-soft"
                  value={theme}
                  onChange={(e)=>setTheme(e.target.value)}
                >
                  {Object.entries(themeConfigs).map(([k,v])=>(
                    <option key={k} value={k}>{v.label}</option>
                  ))}
                </select>
              </div>
            )}

            {/* Fields grid */}
            <div className="grid gap-3 sm:grid-cols-2">
              {themeConfigs[theme].fields.map(def=>(
                <Field
                  key={`${def.name}-${formKey}`}
                  def={def}
                  value={dyn[def.name]}
                  onChange={(v)=>setDyn(p=>({...p,[def.name]:v}))}
                  rememberValue={rememberValue}
                />
              ))}
            </div>

            {/* Datalists for type-ahead suggestions */}
            <datalist id="finishList">
              {[...HISTORY_DEFAULTS.finish, ...hist.finish].map((opt, i, arr) => {
                const firstIdx = arr.findIndex(x => x.toLowerCase() === opt.toLowerCase());
                if (firstIdx !== i) return null;
                return <option key={`f-${i}`} value={opt} />;
              })}
            </datalist>
            <datalist id="sizeList">
              {[...HISTORY_DEFAULTS.size, ...hist.size].map((opt, i, arr) => {
                const firstIdx = arr.findIndex(x => x.toLowerCase() === opt.toLowerCase());
                if (firstIdx !== i) return null;
                return <option key={`s-${i}`} value={opt} />;
              })}
            </datalist>
            <datalist id="randomList">
              {[...HISTORY_DEFAULTS.random, ...hist.random].map((opt, i, arr) => {
                const firstIdx = arr.findIndex(x => x.toLowerCase() === opt.toLowerCase());
                if (firstIdx !== i) return null;
                return <option key={`r-${i}`} value={opt} />;
              })}
            </datalist>

            <div className="hidden sm:flex items-center gap-3">
              <button className={`rounded-2xl px-4 py-2 text-white font-semibold shadow ring-focus btn-soft ${submitting?'bg-slate-400 cursor-not-allowed':'bg-slate-900 hover:bg-black/90'}`} disabled={submitting}>
                {submitting ? (<span className="inline-flex items-center gap-2"><span className="h-4 w-4 rounded-full border-2 border-white/70 border-r-transparent animate-spin"></span>Saving…</span>) : 'Save / Update Design'}
              </button>
            </div>
          </form>

          <div className="sm:hidden">
            <div className="glass rounded-2xl p-3 fade-in-up">
              <div className="flex items-center justify-between gap-2">
                <div className="seg seg-scroll">
                  <button type="button" className={(sortMode==='name_asc'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('name_asc')}>A–Z</button>
                  <button type="button" className={(sortMode==='time_desc'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('time_desc')}>New → Old</button>
                  <button type="button" className={(sortMode==='manual'?'on ':'')+'btn-soft'} onClick={()=>setSortMode('manual')}>Manual</button>
                </div>
                <button type="button"
                        onClick={()=>setShowDesigns(s=>!s)}
                        className="inline-flex items-center gap-2 rounded-full bg-white border border-slate-200 text-slate-700 shadow-sm hover:bg-slate-50 ring-focus px-3 py-2">
                  {showDesigns?'Hide':'Show'} designs
                </button>
              </div>
            </div>
          </div>

          <div className="flex items-center justify-between fade-in-up">
            <div className="text-[15px] font-semibold text-slate-800">
              Designs • <span className="font-bold">{themeConfigs[theme]?.label || 'Default'}</span>
              <span className="text-slate-500 font-normal"> {sortMode==='manual' ? '(manual order)' : ''}</span>
            </div>
            {sortMode==='manual' && (
              <button onClick={saveManualOrder}
                className="rounded-full bg-white px-4 py-2 text-sm font-semibold border border-slate-200 shadow-sm hover:bg-slate-50 ring-focus btn-soft">
                Save Order
              </button>
            )}
          </div>

          {loading ? (
            <div className="glass rounded-2xl p-6 text-slate-600 fade-in-up">Loading…</div>
          ) : (
            <div className={showDesigns ? "grid md:grid-cols-2 gap-4 fade-in-up" : "hidden"}>
              {(sortMode==='manual' ? manualList : filteredSortedDesigns).length===0 ? (
                <div className="glass rounded-2xl p-6 text-slate-600 fade-in-up">No designs for this theme yet.</div>
              ) : (sortMode==='manual' ? manualList : filteredSortedDesigns).map((d,i)=>(
                <div key={d.id}
                     className={`glass rounded-2xl p-4 ${sortMode==='manual'?'cursor-move':''} card-hover`}
                     draggable={sortMode==='manual'}
                     onDragStart={sortMode==='manual'?onDragStart(i):undefined}
                     onDragOver={sortMode==='manual'?onDragOver(i):undefined}
                     onDrop={sortMode==='manual'?onDrop(i):undefined}>
                  <div className="flex items-start gap-3">
                    <div className="flex-1">
                      <div className="font-semibold text-slate-900">{d.label}</div>
                      <div className="text-xs text-slate-500">ID: {d.id} • Theme: {d.theme||'default'}</div>
                    </div>
                    <button type="button" onClick={(e)=>{e.preventDefault();e.stopPropagation();deleteDesign(d);}}
                            className="inline-flex items-center justify-center h-8 w-8 rounded-full bg-white border border-red-200 text-red-600 hover:bg-red-50 ring-focus btn-soft"
                            title="Remove design">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 12a1 1 0 011-1h10a1 1 0 010 2H7a1 1 0 01-1-1z"/></svg>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          <Toast toast={toast}/>

          <div className="sm:hidden fab-stack">
            <div className="fab-col">
              <button onClick={()=>{const f=document.getElementById('uploadForm');if(f)f.requestSubmit();}}
                      className={`fab-btn-sm inline-flex items-center gap-2 bg-slate-900 text-white btn-soft ring-focus ${submitting?'opacity-70 cursor-not-allowed':''}`}
                      disabled={submitting} title="Save / Update">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M5 13h14v2H5zM5 17h10v2H5zM5 7h14v2H5z"/></svg>
                Save
              </button>
              <FullCatalogueBtn theme={theme} sortMode={sortMode} size="sm"/>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
